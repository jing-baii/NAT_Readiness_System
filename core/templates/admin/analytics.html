{% extends 'base.html' %}
{% load static %}
{% load mathfilters %}
{% load custom_filters %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/analytics.css' %}">
<style>
.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

.chart-wrapper {
    position: relative;
    cursor: pointer;
    padding: 10px;
    border-radius: 8px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: all 0.2s ease-in-out;
    /* Add a subtle border to define the container */
    border: 1px solid rgba(0,0,0,0.05);
}

/* Improve hover state */
.chart-wrapper:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: rgba(0,0,0,0.1);
    /* Add a subtle background change */
    background: linear-gradient(to bottom, #ffffff, #fafafa);
}

/* Add a hover indicator */
.chart-wrapper::after {
    content: 'Click to expand';
    position: absolute;
    bottom: 5px;
    right: 10px;
    font-size: 0.75rem;
    color: #6c757d;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
}

.chart-wrapper:hover::after {
    opacity: 1;
}

.chart-wrapper.expanded {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80vw;
    max-width: 1200px;
    height: 80vh;
    max-height: 800px;
    z-index: 1000;
    background: white;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    border-radius: 8px;
    padding: 20px;
    cursor: default;
    border: none;
}

/* Remove hover effects when expanded */
.chart-wrapper.expanded:hover {
    background: white;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
}

.chart-wrapper.expanded::after {
    display: none;
}

/* Ensure chart fills container when expanded */
.chart-wrapper.expanded .chart-container {
    height: calc(100% - 40px);
    width: 100%;
}

.chart-label {
    font-weight: 500;
    margin-bottom: 10px;
    color: #495057;
    font-size: 1.1rem;
    /* Add a subtle transition for the label */
    transition: color 0.2s ease-in-out;
}

.chart-wrapper:hover .chart-label {
    color: #0d6efd;
}

/* Overlay when chart is expanded */
.chart-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
}

.chart-overlay.active {
    display: block;
    opacity: 1;
}

/* Close button for expanded chart */
.chart-close-btn {
    display: none;
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 1001;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: background-color 0.2s ease;
    opacity: 0;
}

.chart-close-btn.active {
    display: block;
    opacity: 1;
}

.chart-close-btn:hover {
    background: #c82333;
}

/* Make charts responsive */
@media (max-width: 768px) {
    .chart-container {
        height: 250px;
    }
    .chart-wrapper.expanded {
        width: 95vw;
        height: 90vh;
        padding: 15px;
    }
    .chart-wrapper.expanded .chart-container {
        height: calc(100% - 30px);
    }
    .chart-label {
        font-size: 1rem;
    }
}

/* Activity Logs Styles */
.activity-logs-container {
    padding: 10px;
}

.activity-timeline {
    position: relative;
    padding-left: 30px;
}

.activity-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.activity-item {
    position: relative;
    padding: 15px 0;
    display: flex;
    align-items: flex-start;
}

.activity-icon {
    position: absolute;
    left: -30px;
    width: 30px;
    height: 30px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 1;
}

.activity-content {
    flex: 1;
    background: #f8f9fa;
    padding: 12px 15px;
    border-radius: 8px;
    margin-left: 15px;
    transition: all 0.2s ease-in-out;
}

.activity-item:hover .activity-content {
    background: #e9ecef;
    transform: translateX(5px);
}

.activity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.activity-user {
    font-weight: 500;
    color: #495057;
}

.activity-time {
    font-size: 0.85rem;
    color: #6c757d;
}

.activity-details {
    color: #212529;
    margin-bottom: 5px;
}

.activity-meta {
    border-top: 1px solid #dee2e6;
    padding-top: 8px;
    margin-top: 8px;
}

/* Activity filter buttons */
.activity-filter {
    transition: all 0.2s ease-in-out;
}

.activity-filter.active {
    background-color: #0d6efd;
    color: white;
}

/* Hide filtered activities */
.activity-item[data-type]:not([data-type="all"]) {
    display: none;
}

.activity-item[data-type="all"] {
    display: flex;
}

/* Scrollbar styling */
.activity-logs-container::-webkit-scrollbar {
    width: 8px;
}

.activity-logs-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.activity-logs-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.activity-logs-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Activity type colors */
.text-purple {
    color: #6f42c1;
}

.activity-icon i {
    font-size: 1.1rem;
}

/* Improve activity meta display */
.activity-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #dee2e6;
}

.activity-meta span {
    background: #f8f9fa;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
}

/* Improve activity filter buttons */
.activity-filter {
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
    border-radius: 4px;
    margin: 0 0.25rem;
}

.activity-filter.active {
    background-color: #0d6efd;
    color: white;
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.2);
}

/* Improve activity item hover */
.activity-item:hover .activity-content {
    background: #f8f9fa;
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* Add loading state */
.activity-logs-container.loading {
    position: relative;
    min-height: 200px;
}

.activity-logs-container.loading::after {
    content: 'Loading activities...';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #6c757d;
}

/* Improve scrollbar */
.activity-logs-container {
    scrollbar-width: thin;
    scrollbar-color: #c1c1c1 #f1f1f1;
}

.activity-logs-container::-webkit-scrollbar {
    width: 6px;
}

.activity-logs-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.activity-logs-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.activity-logs-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Add styles for subject success rates */
.subject-success-container {
    background: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.subject-success-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.subject-success-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
}

.subject-success-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 1rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 6px;
}

.legend-item {
    display: flex;
    align-items: center;
    font-size: 0.875rem;
    color: #495057;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 3px;
    margin-right: 0.5rem;
}

.subject-success-chart {
    position: relative;
    height: 400px;
    margin-top: 1rem;
}

/* Update chart wrapper styles for subject success */
.chart-wrapper[data-chart="subject"] {
    padding: 1.5rem;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.chart-wrapper[data-chart="subject"] .chart-container {
    height: 400px;
}

.chart-wrapper[data-chart="subject"].expanded .chart-container {
    height: calc(100% - 60px);
}

/* Survey Response Table Styles */
.survey-table-container {
    position: relative;
    z-index: 1;
    background: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.survey-table-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f0f0f0;
}

.survey-table-header h5 {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
}

.survey-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-bottom: 1.5rem;
}

.survey-table th {
    background: #f8f9fa;
    color: #495057;
    font-weight: 600;
    padding: 1rem;
    text-align: center;
    border: 1px solid #dee2e6;
    white-space: nowrap;
}

.survey-table td {
    padding: 0.75rem 1rem;
    border: 1px solid #dee2e6;
    text-align: center;
    vertical-align: middle;
}

.survey-table tbody tr:hover {
    background-color: #f8f9fa;
}

.survey-table-responsive {
    position: relative;
    z-index: 1;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0 -1.5rem;
    padding: 0 1.5rem;
}

/* Likert Scale Table Styles */
.likert-table {
    width: 100%;
    margin-bottom: 2rem;
    border-collapse: separate;
    border-spacing: 0;
}

.likert-table th {
    background: #f8f9fa;
    color: #495057;
    font-weight: 600;
    padding: 0.75rem;
    text-align: center;
    border: 1px solid #dee2e6;
}

.likert-table td {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    text-align: center;
}

.likert-table tfoot th {
    background: #e9ecef;
    font-weight: 600;
}

/* Question Container Styles */
.question-container {
    background: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.question-header {
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #f0f0f0;
}

.question-header h6 {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
}

.weighted-mean-display {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 6px;
    margin-top: 1rem;
    text-align: center;
    font-size: 1.1rem;
    color: #495057;
}

/* Interpretation Legend Styles */
.interpretation-legend {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 2rem;
}

.interpretation-legend strong {
    color: #2c3e50;
    display: block;
    margin-bottom: 0.75rem;
}

.interpretation-legend ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.5rem;
}

.interpretation-legend li {
    padding: 0.5rem;
    background: #fff;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .survey-table-container,
    .question-container {
        padding: 1rem;
    }
    
    .survey-table th,
    .survey-table td {
        padding: 0.5rem;
        font-size: 0.9rem;
    }
    
    .interpretation-legend ul {
        grid-template-columns: 1fr;
    }
    
    .weighted-mean-display {
        font-size: 1rem;
        padding: 0.75rem;
    }
}

/* Add these styles in the style section */
.survey-table.column-view th {
    position: sticky;
    top: 0;
    z-index: 25;
    background: #f8f9fa;
}

.survey-table.column-view td:first-child {
    position: sticky;
    left: 0;
    z-index: 20;
    background: #f8f9fa;
}

.survey-table.column-view td:nth-child(2) {
    position: sticky;
    left: 120px;
    z-index: 20;
    background: #f8f9fa;
}

.survey-table.column-view th:first-child,
.survey-table.column-view th:nth-child(2) {
    z-index: 26;
}

.survey-table.column-view td,
.survey-table.column-view th {
    min-width: 100px;
}

.survey-table.column-view td:first-child,
.survey-table.column-view th:first-child {
    min-width: 120px;
}

.survey-table.column-view td:nth-child(2),
.survey-table.column-view th:nth-child(2) {
    min-width: 100px;
}

.survey-table-responsive {
    max-height: 600px;
    overflow: auto;
}

/* Add these styles in the style section */
.survey-analysis-container {
    position: relative;
    max-height: 800px;
    overflow-y: auto;
    padding-right: 1rem;
    background: #fff;
    z-index: 1;
}

.survey-analysis-container .card {
    position: relative;
    background: #fff;
    z-index: 1;
}

.survey-analysis-container .card-header {
    position: sticky;
    top: 0;
    z-index: 30;
    background: #fff;
    border-bottom: 2px solid #f0f0f0;
    padding: 1rem 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.survey-analysis-container .card-body {
    position: relative;
    z-index: 1;
    background: #fff;
    padding-top: 1.5rem;
}

/* Custom scrollbar for the survey analysis container */
.survey-analysis-container::-webkit-scrollbar {
    width: 8px;
}

.survey-analysis-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.survey-analysis-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.survey-analysis-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Ensure proper spacing between sections */
.survey-section {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #f0f0f0;
}

.survey-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

/* Add these styles in the style section */
.activity-logs-section {
    position: relative;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.activity-logs-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 2px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.activity-logs-header h5 {
    margin: 0;
    color: #2c3e50;
    font-weight: 600;
}

.activity-filter-group {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.activity-filter {
    padding: 0.5rem 1rem;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    background: #fff;
    color: #495057;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.activity-filter:hover {
    background: #f8f9fa;
    border-color: #ced4da;
}

.activity-filter.active {
    background: #0d6efd;
    color: #fff;
    border-color: #0d6efd;
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.2);
}

.activity-logs-container {
    position: relative;
    max-height: 600px;
    overflow-y: auto;
    padding: 1.5rem;
}

.activity-timeline {
    position: relative;
    padding-left: 2rem;
}

.activity-timeline::before {
    content: '';
    position: absolute;
    left: 0.75rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, #e9ecef 0%, #dee2e6 100%);
}

.activity-item {
    position: relative;
    padding: 1rem 0;
    display: flex;
    align-items: flex-start;
}

.activity-icon {
    position: absolute;
    left: -2rem;
    width: 1.5rem;
    height: 1.5rem;
    background: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 1;
    border: 2px solid #fff;
}

.activity-icon i {
    font-size: 0.875rem;
    color: #fff;
}

.activity-icon.login { background: #28a745; }
.activity-icon.logout { background: #6c757d; }
.activity-icon.quiz_attempt { background: #0d6efd; }
.activity-icon.study_material { background: #17a2b8; }

.activity-content {
    flex: 1;
    background: #f8f9fa;
    padding: 1rem 1.25rem;
    border-radius: 8px;
    margin-left: 1rem;
    transition: all 0.2s ease;
    border: 1px solid #e9ecef;
}

.activity-item:hover .activity-content {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border-color: #dee2e6;
}

.activity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.activity-user {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.95rem;
}

.activity-time {
    font-size: 0.8rem;
    color: #6c757d;
    background: #fff;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    border: 1px solid #e9ecef;
}

.activity-details {
    color: #495057;
    font-size: 0.9rem;
    line-height: 1.5;
}

.activity-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #e9ecef;
}

.activity-meta span {
    background: #fff;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.8rem;
    color: #6c757d;
    border: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.activity-meta i {
    font-size: 0.875rem;
}

/* Loading state */
.activity-logs-container.loading::after {
    content: 'Loading activities...';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #6c757d;
    font-size: 0.9rem;
    background: #fff;
    padding: 1rem 2rem;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Custom scrollbar for activity logs */
.activity-logs-container::-webkit-scrollbar {
    width: 6px;
}

.activity-logs-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.activity-logs-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.activity-logs-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .activity-logs-header {
        padding: 1rem;
    }
    
    .activity-filter {
        padding: 0.4rem 0.75rem;
        font-size: 0.8rem;
    }
    
    .activity-logs-container {
        padding: 1rem;
    }
    
    .activity-content {
        padding: 0.75rem 1rem;
    }
    
    .activity-meta span {
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
    }
}

/* Loading Skeleton Styles */
.skeleton-text {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
}

.skeleton-button {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 6px;
}

.skeleton-chart {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
    height: 300px;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.activity-item { transition: opacity 0.2s ease, transform 0.2s ease; opacity: 1; transform: translateX(0); }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Loading Skeleton -->
    <div id="loading-skeleton">
        <!-- Header Skeleton -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="skeleton-text" style="width: 250px; height: 32px;"></div>
                        <div class="skeleton-text" style="width: 200px; height: 20px; margin-top: 8px;"></div>
                    </div>
                    <div class="d-flex gap-2">
                        <div class="skeleton-button" style="width: 120px; height: 38px;"></div>
                        <div class="skeleton-button" style="width: 38px; height: 38px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overview Cards Skeleton -->
        <div class="row mb-4">
            {% for i in '1234'|make_list %}
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="skeleton-text" style="width: 120px; height: 20px;"></div>
                        <div class="skeleton-text" style="width: 80px; height: 32px; margin-top: 8px;"></div>
                        <div class="skeleton-text" style="width: 100px; height: 20px; margin-top: 16px;"></div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Charts Skeleton -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <div class="skeleton-text" style="width: 150px; height: 24px;"></div>
                    </div>
                    <div class="card-body">
                        <div class="skeleton-chart"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <div class="skeleton-text" style="width: 150px; height: 24px;"></div>
                    </div>
                    <div class="card-body">
                        <div class="skeleton-chart"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Analytics Skeleton -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="skeleton-text" style="width: 200px; height: 24px;"></div>
                        <div class="d-flex gap-2">
                            <div class="skeleton-button" style="width: 80px; height: 32px;"></div>
                            <div class="skeleton-button" style="width: 80px; height: 32px;"></div>
                            <div class="skeleton-button" style="width: 80px; height: 32px;"></div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="skeleton-chart"></div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="skeleton-chart"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actual Content -->
    <div id="content" class="d-none">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold mb-1">Analytics Dashboard</h2>
                    <p class="text-muted mb-0">Comprehensive analysis of system usage and performance</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                    <button id="refreshAnalyticsBtn" class="btn btn-outline-secondary" title="Refresh Analytics">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card fade-in">
                <div class="card-body">
                    <h6 class="card-title">Total Students</h6>
                    <h3 class="mb-0">{{ total_students }}</h3>
                    <div class="mt-2">
                        <span class="text-success">
                            <i class="fas fa-users me-1"></i>
                            {{ active_students }} active
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card fade-in">
                <div class="card-body">
                    <h6 class="card-title">Student Engagement</h6>
                    <h3 class="mb-0">{{ engagement_rate }}%</h3>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar bg-success" style="width: {{ engagement_rate }}%;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card fade-in">
                <div class="card-body">
                    <h6 class="card-title">Total Responses</h6>
                    <h3 class="mb-0">{{ total_responses }}</h3>
                    <div class="mt-2">
                        <span class="text-info">
                            <i class="fas fa-check-circle me-1"></i>
                            {{ correct_responses }} correct
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card fade-in">
                <div class="card-body">
                    <h6 class="card-title">Question Types</h6>
                    <h3 class="mb-0">{{ type_distribution|length }}</h3>
                    <div class="mt-2">
                        <span class="text-primary">
                            <i class="fas fa-question-circle me-1"></i>
                            Different types
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Charts -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card fade-in">
                <div class="card-header">
                    <h5 class="card-title">Daily Activity</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                    <canvas id="dailyActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card fade-in">
                <div class="card-header">
                    <h5 class="card-title">Weekly Activity</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                    <canvas id="weeklyActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Analytics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card fade-in">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title">Performance Analytics</h5>
                    <form id="date-range-form" class="d-flex align-items-center gap-2 mb-0" onsubmit="return false;">
                        <label for="start-date" class="mb-0">From:</label>
                        <input type="date" id="start-date" class="form-control form-control-sm" style="width: 140px;">
                        <label for="end-date" class="mb-0">To:</label>
                        <input type="date" id="end-date" class="form-control form-control-sm" style="width: 140px;">
                        <button type="submit" class="btn btn-sm btn-primary">Apply</button>
                    </form>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="chart-label">Student Performance Distribution</div>
                            <div class="chart-wrapper" data-chart="performance">
                                <div class="chart-container">
                                    <canvas id="performanceDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="subject-success-container">
                                <div class="subject-success-header">
                                    <h5 class="subject-success-title">Subject Success Rates</h5>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary active" data-view="chart">Chart</button>
                                        <button type="button" class="btn btn-outline-secondary" data-view="table">Table</button>
                                    </div>
                                </div>
                                <div class="chart-wrapper" data-chart="subject">
                                    <div class="chart-container">
                                        <canvas id="subjectSuccessChart"></canvas>
                                    </div>
                                    <div class="subject-success-legend" id="subjectSuccessLegend">
                                        <!-- Legend items will be dynamically populated -->
                                    </div>
                                </div>
                                <div class="subject-success-table d-none">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Subject</th>
                                                    <th>Success Rate</th>
                                                    <th>Progress</th>
                                                </tr>
                                            </thead>
                                            <tbody id="subjectSuccessTableBody">
                                                <!-- Table rows will be dynamically populated -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="chart-label">Question Difficulty Analysis</div>
                            <div class="chart-wrapper" data-chart="difficulty">
                                <div class="chart-container">
                                    <canvas id="difficultyAnalysisChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="chart-label">Learning Progress by Level</div>
                            <div class="chart-wrapper" data-chart="progress">
                                <div class="chart-container">
                                    <canvas id="learningProgressChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Logs Section -->
    <div class="card activity-logs-section">
        <div class="activity-logs-header">
            <h5>Activity Logs</h5>
            <div class="activity-filter-group">
                <button type="button" class="activity-filter active" data-filter="all" aria-pressed="true">
                    <i class="fas fa-list"></i> All
                </button>
                <button type="button" class="activity-filter" data-filter="login" aria-pressed="false">
                    <i class="fas fa-sign-in-alt"></i> Logins
                </button>
                <button type="button" class="activity-filter" data-filter="logout" aria-pressed="false">
                    <i class="fas fa-sign-out-alt"></i> Logouts
                </button>
                <button type="button" class="activity-filter" data-filter="quiz_attempt" aria-pressed="false">
                    <i class="fas fa-question-circle"></i> Quizzes
                </button>
                <button type="button" class="activity-filter" data-filter="study_material" aria-pressed="false">
                    <i class="fas fa-book"></i> Study
                </button>
            </div>
        </div>
        <div class="activity-logs-container">
            <div class="activity-timeline" id="activityLogs">
                {% for log in activity_logs %}
                <div class="activity-item" data-type="{{ log.type }}" style="display: flex;">
                    <div class="activity-icon {{ log.type }}">
                        {% if log.type == 'login' %}
                        <i class="fas fa-sign-in-alt"></i>
                        {% elif log.type == 'logout' %}
                        <i class="fas fa-sign-out-alt"></i>
                        {% elif log.type == 'quiz_attempt' %}
                        <i class="fas fa-question-circle"></i>
                        {% elif log.type == 'study_material' %}
                        <i class="fas fa-book"></i>
                        {% endif %}
                    </div>
                    <div class="activity-content">
                        <div class="activity-header">
                            <span class="activity-user">{{ log.user }}</span>
                            <span class="activity-time">{{ log.timestamp|timesince }} ago</span>
                        </div>
                        <div class="activity-details">
                            {{ log.description }}
                        </div>
                        {% if log.details %}
                        <div class="activity-meta">
                            {% if log.type == 'login' %}
                            <span><i class="fas fa-globe"></i> {{ log.details.ip|default:"Unknown IP" }}</span>
                            <span><i class="fas fa-desktop"></i> {{ log.details.browser|default:"Unknown Browser" }}</span>
                            {% elif log.type == 'logout' and log.details.session_duration %}
                            <span><i class="fas fa-clock"></i> Session duration: {{ log.details.session_duration }}</span>
                            {% elif log.type == 'quiz_attempt' %}
                            <span><i class="fas fa-book"></i> {{ log.details.subject }}</span>
                            <span><i class="fas fa-chart-bar"></i> Score: {{ log.details.score }}%</span>
                            {% elif log.type == 'study_material' %}
                            <span><i class="fas fa-book"></i> {{ log.details.subject }}</span>
                            <span><i class="fas fa-file-alt"></i> {{ log.details.material_type }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Subject Performance Table -->
    <div class="row">
        <div class="col-12">
            <div class="card fade-in">
                <div class="card-header">
                    <h5 class="card-title">Subject Performance</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Attempts</th>
                                    <th>Correct</th>
                                    <th>Success Rate</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for subject, data in subject_performance.items %}
                                <tr>
                                    <td>{{ subject }}</td>
                                    <td>{{ data.attempts }}</td>
                                    <td>{{ data.correct }}</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar {% if data.success_rate >= 70 %}bg-success{% elif data.success_rate >= 40 %}bg-warning{% else %}bg-danger{% endif %}"
                                                 role="progressbar" 
                                                 style="width: {{ data.success_rate }}%;"
                                                 aria-valuenow="{{ data.success_rate }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                {{ data.success_rate }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if data.progress > 0 %}
                                        <span class="text-success">↑ {{ data.progress }}%</span>
                                        {% elif data.progress < 0 %}
                                        <span class="text-danger">↓ {{ data.progress|abs }}%</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Survey Response Analysis -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Survey Response Analysis</h5>
        </div>
        <div class="card-body">
            <!-- Legend -->
            <div class="alert alert-info mb-4">
                <h6 class="alert-heading">Interpretation Guide</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Likert Scale:</strong>
                        <ul class="mb-0">
                            <li>5 = Strongly Agree</li>
                            <li>4 = Agree</li>
                            <li>3 = Moderate</li>
                            <li>2 = Disagree</li>
                            <li>1 = Strongly Disagree</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <strong>Weighted Mean Interpretation:</strong>
                        <ul class="mb-0">
                            <li><span class="text-success">Agree</span> (≥ 3.5)</li>
                            <li><span class="text-warning">Moderate</span> (2.5 - 3.4)</li>
                            <li><span class="text-danger">Not Agree</span> (≤ 2.4)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Experience Section -->
            <div class="mb-4">
                <h5 class="border-bottom pb-2">Experience</h5>
                <div class="table-responsive">
                    <table id="experience-table" class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Question</th>
                                <th>1</th>
                                <th>2</th>
                                <th>3</th>
                                <th>4</th>
                                <th>5</th>
                                <th>Weighted Mean</th>
                                <th>Interpretation</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Difficulty Section -->
            <div class="mb-4">
                <h5 class="border-bottom pb-2">Difficulty</h5>
                <div class="table-responsive">
                    <table id="difficulty-table" class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Question</th>
                                <th>1</th>
                                <th>2</th>
                                <th>3</th>
                                <th>4</th>
                                <th>5</th>
                                <th>Weighted Mean</th>
                                <th>Interpretation</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Control Section -->
            <div class="mb-4">
                <h5 class="border-bottom pb-2">Control</h5>
                <div class="table-responsive">
                    <table id="control-table" class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Question</th>
                                <th>1</th>
                                <th>2</th>
                                <th>3</th>
                                <th>4</th>
                                <th>5</th>
                                <th>Weighted Mean</th>
                                <th>Interpretation</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-end gap-2">
                <button id="refresh-survey" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
                <button id="export-survey" class="btn btn-success">
                    <i class="fas fa-file-export"></i> Export to CSV
                </button>
            </div>

            <!-- Conclusion and Weighted Mean Formula -->
            <div class="mt-4">
                <div class="alert alert-secondary">
                    <h6 class="mb-2">Conclusion</h6>
                    <div id="dynamic-conclusion">
                        The survey results above provide a comprehensive overview of respondents' perceptions regarding Experience, Difficulty, and Control. The weighted mean for each section reflects the overall tendency of responses, with interpretations based on the defined Likert scale. Higher weighted means indicate stronger agreement, while lower means suggest areas for improvement.
                    </div>
                </div>
                <div class="alert alert-light">
                    <h6 class="mb-2">Formula for Weighted Mean</h6>
                    <p>
                        The weighted mean for Likert-scale responses is calculated as:
                    </p>
                    <p class="mb-0" style="font-size:1.1em;">
                        $$
                        \text{Weighted Mean} = \frac{\sum_{i=1}^{n} (f_i \times x_i)}{\sum_{i=1}^{n} f_i}
                        $$
                    </p>
                    <ul class="mb-0">
                        <li><strong>\(f_i\)</strong>: Frequency (number of responses) for Likert value \(x_i\)</li>
                        <li><strong>\(x_i\)</strong>: Likert scale value (1 to 5)</li>
                        <li><strong>n</strong>: Number of Likert choices (here, 5)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Likert Scale Weighted Mean Analysis -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Likert Scale Weighted Mean Analysis</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Experience Analysis -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Experience Rating Analysis</h6>
                        </div>
                        <div class="card-body">
                            <div class="weighted-mean-display">
                                <h6>Weighted Mean</h6>
                                <h3 id="experience-weighted-mean">0.0</h3>
                                <p class="text-muted mb-0" id="experience-interpretation">No data available</p>
                            </div>
                            <div class="mt-3">
                                <h6>Interpretation</h6>
                                <ul class="list-unstyled">
                                    <li><strong>4.21 - 5.00:</strong> Strongly Agree (5)</li>
                                    <li><strong>3.41 - 4.20:</strong> Agree (4)</li>
                                    <li><strong>2.61 - 3.40:</strong> Neutral (3)</li>
                                    <li><strong>1.81 - 2.60:</strong> Not Agree (2)</li>
                                    <li><strong>1.00 - 1.80:</strong> Strongly Not Agree (1)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Difficulty Analysis -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Difficulty Rating Analysis</h6>
                        </div>
                        <div class="card-body">
                            <div class="weighted-mean-display">
                                <h6>Weighted Mean</h6>
                                <h3 id="difficulty-weighted-mean">0.0</h3>
                                <p class="text-muted mb-0" id="difficulty-interpretation">No data available</p>
                            </div>
                            <div class="mt-3">
                                <h6>Interpretation</h6>
                                <ul class="list-unstyled">
                                    <li><strong>4.21 - 5.00:</strong> Strongly Agree (5)</li>
                                    <li><strong>3.41 - 4.20:</strong> Agree (4)</li>
                                    <li><strong>2.61 - 3.40:</strong> Neutral (3)</li>
                                    <li><strong>1.81 - 2.60:</strong> Not Agree (2)</li>
                                    <li><strong>1.00 - 1.80:</strong> Strongly Not Agree (1)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Control Analysis -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">System Control Analysis</h6>
                        </div>
                        <div class="card-body">
                            <div class="weighted-mean-display">
                                <h6>Weighted Mean</h6>
                                <h3 id="control-weighted-mean">0.0</h3>
                                <p class="text-muted mb-0" id="control-interpretation">No data available</p>
                            </div>
                            <div class="mt-3">
                                <h6>Interpretation</h6>
                                <ul class="list-unstyled">
                                    <li><strong>4.21 - 5.00:</strong> Strongly Agree (5)</li>
                                    <li><strong>3.41 - 4.20:</strong> Agree (4)</li>
                                    <li><strong>2.61 - 3.40:</strong> Neutral (3)</li>
                                    <li><strong>1.81 - 2.60:</strong> Not Agree (2)</li>
                                    <li><strong>1.00 - 1.80:</strong> Strongly Not Agree (1)</li>
                                </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this after the Likert Scale Weighted Mean Analysis section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Detailed Survey Responses</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="survey-responses-table" class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Student</th>
                            <th>Experience</th>
                            <th>Difficulty</th>
                            <th>Control</th>
                            <th>Feedback</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="survey-responses-body">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Chart instances
let performanceChart = null;
let subjectSuccessChart = null;
let difficultyChart = null;
let progressChart = null;

// Add these variables at the top with other chart instances
let chartOverlay = null;
let closeButton = null;
let activeChart = null;
const charts = {
    performance: performanceChart,
    subject: subjectSuccessChart,
    difficulty: difficultyChart,
    progress: progressChart
};

// Show skeleton before fetching data
function showLoadingSkeleton() {
    document.getElementById('loading-skeleton').classList.remove('d-none');
    document.getElementById('content').classList.add('d-none');
}
function hideLoadingSkeleton() {
    document.getElementById('loading-skeleton').classList.add('d-none');
    document.getElementById('content').classList.remove('d-none');
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize all charts
    initializePerformanceChart();
    initializeSubjectSuccessChart();
    initializeDifficultyChart();
    initializeLearningProgressChart();
    // Show skeleton and load initial data
    showLoadingSkeleton();
    updateChartTimeRange('week');
    // ... rest of your DOMContentLoaded code ...
    // Add event listeners for time range buttons
    document.querySelectorAll('.time-range-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // Add active class to clicked button
            this.classList.add('active');
            // Show skeleton and update charts with selected time range
            showLoadingSkeleton();
            updateChartTimeRange(this.dataset.range);
        });
    });
    // ... rest of your DOMContentLoaded code ...
});

// ... existing JavaScript code ...

    // Initialize all charts
    initializePerformanceChart();
    initializeSubjectSuccessChart();
    initializeDifficultyChart();
    initializeLearningProgressChart();
    
    // Initialize overlay and close button
    chartOverlay = document.querySelector('.chart-overlay');
    closeButton = document.createElement('button');
    closeButton.className = 'chart-close-btn';
    closeButton.innerHTML = '×';
    document.body.appendChild(closeButton);
    
    // Add click handlers to all chart wrappers
    document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
        wrapper.addEventListener('click', function(e) {
            if (!this.classList.contains('expanded')) {
                // Close any previously expanded chart
                if (activeChart) {
                    activeChart.classList.remove('expanded');
                }
                
                // Expand this chart
                this.classList.add('expanded');
                chartOverlay.classList.add('active');
                closeButton.classList.add('active');
                activeChart = this;
                
                // Update chart size
                const chartType = this.dataset.chart;
                if (charts[chartType]) {
                    charts[chartType].resize();
                }
                
                // Prevent click from bubbling to overlay
                e.stopPropagation();
            }
        });
    });
    
    // Close button handler
    closeButton.addEventListener('click', function(e) {
        if (activeChart) {
            activeChart.classList.remove('expanded');
            chartOverlay.classList.remove('active');
            this.classList.remove('active');
            
            // Update chart size
            const chartType = activeChart.dataset.chart;
            if (charts[chartType]) {
                charts[chartType].resize();
            }
            
            activeChart = null;
        }
        e.stopPropagation();
    });
    
    // Overlay click handler
    chartOverlay.addEventListener('click', function() {
        if (activeChart) {
            activeChart.classList.remove('expanded');
            this.classList.remove('active');
            closeButton.classList.remove('active');
            
            // Update chart size
            const chartType = activeChart.dataset.chart;
            if (charts[chartType]) {
                charts[chartType].resize();
            }
            
            activeChart = null;
        }
    });
    
    // Add keyboard support
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && activeChart) {
            activeChart.classList.remove('expanded');
            chartOverlay.classList.remove('active');
            closeButton.classList.remove('active');
            
            // Update chart size
            const chartType = activeChart.dataset.chart;
            if (charts[chartType]) {
                charts[chartType].resize();
            }
            
            activeChart = null;
        }
    });
    
    // Load initial data with 'week' time range
    updateChartTimeRange('week');
    
    // Add event listeners for time range buttons
    document.querySelectorAll('.time-range-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // Add active class to clicked button
            this.classList.add('active');
            // Update charts with selected time range
            updateChartTimeRange(this.dataset.range);
        });
    });

    // Add resize observer to handle chart resizing
    const resizeObserver = new ResizeObserver(entries => {
        for (let entry of entries) {
            const wrapper = entry.target;
            if (wrapper.classList.contains('expanded')) {
                const chartType = wrapper.dataset.chart;
                if (charts[chartType]) {
                    charts[chartType].resize();
                }
            }
        }
    });

    // Observe all chart wrappers
    document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
        resizeObserver.observe(wrapper);
    });

    // Update Activity Logs filtering
    const filterButtons = document.querySelectorAll('.activity-filter');
    const activityItems = document.querySelectorAll('.activity-item');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            
            // Filter activities with smooth transition
            activityItems.forEach(item => {
                if (filter === 'all' || item.dataset.type === filter) {
                    item.style.display = 'flex';
                    // Add a small delay for smooth transition
                    setTimeout(() => {
                        item.style.opacity = '1';
                        item.style.transform = 'translateX(0)';
                    }, 50);
                } else {
                    item.style.opacity = '0';
                    item.style.transform = 'translateX(-10px)';
                    // Hide after transition
                    setTimeout(() => {
                        item.style.display = 'none';
                    }, 200);
                }
            });
        });
    });

    // Add transition styles for activity items
    const style = document.createElement('style');
    style.textContent = `.activity-item { transition: opacity 0.2s ease, transform 0.2s ease; opacity: 1; transform: translateX(0); }`;
    document.head.appendChild(style);

    // Add infinite scroll for activity logs
    const activityContainer = document.querySelector('.activity-logs-container');
    let page = 1;
    let loading = false;
    let hasMore = true;

    function loadMoreActivities() {
        if (loading || !hasMore) return;
        
        loading = true;
        activityContainer.classList.add('loading');
        
        fetch(`/api/analytics/activity-logs/?page=${page}`)
            .then(response => response.json())
            .then(data => {
                if (data.activities.length === 0) {
                    hasMore = false;
                    return;
                }
                
                const timeline = activityContainer.querySelector('.activity-timeline');
                data.activities.forEach(activity => {
                    // Create and append new activity items
                    const activityItem = createActivityItem(activity);
                    timeline.appendChild(activityItem);
                });
                
                page++;
                loading = false;
                activityContainer.classList.remove('loading');
            })
            .catch(error => {
                console.error('Error loading more activities:', error);
                loading = false;
                activityContainer.classList.remove('loading');
            });
    }

    // Create activity item element
    function createActivityItem(activity) {
        const div = document.createElement('div');
        div.className = 'activity-item';
        div.dataset.type = activity.type;
        
        // ... create activity item HTML ...
        // (You can reuse the same structure as in the template)
        
        return div;
    }

    // Add scroll event listener
    activityContainer.addEventListener('scroll', function() {
        if (activityContainer.scrollTop + activityContainer.clientHeight >= activityContainer.scrollHeight - 100) {
            loadMoreActivities();
        }
    });

    // Refresh button handler
    const refreshBtn = document.getElementById('refreshAnalyticsBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            window.location.reload();
        });
    }

    // Initialize survey analysis
    fetchSurveyData();

    // Set up auto-refresh every 5 minutes
    setInterval(fetchSurveyData, 300000);

    // Function to fetch and render survey data
    function fetchSurveyData() {
        fetch('/api/analytics/survey-data/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch survey data');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                ['experience', 'difficulty', 'control'].forEach(section => {
                    const table = document.getElementById(`${section}-table`);
                    if (!table) return;
                    
                    const tbody = table.querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    if (!data.question_tallies || !data.question_tallies[section]) {
                        tbody.innerHTML = '<tr><td colspan="9" class="text-center">No data available</td></tr>';
                        return;
                    }
                    
                    data.question_tallies[section].forEach(q => {
                        const row = document.createElement('tr');
                        
                        // Question label
                        row.innerHTML = `<td>${q.label}</td>`;
                        
                        // Tallies for 1-5
                        for (let i = 1; i <= 5; i++) {
                            row.innerHTML += `<td>${q.tally[i] || 0}</td>`;
                        }
                        
                        // Weighted mean
                        row.innerHTML += `<td>${q.weighted_mean.toFixed(2)}</td>`;
                        
                        // Interpretation
                        let interp = 'Not Agree';
                        let interpClass = 'text-danger';
                        if (q.weighted_mean >= 3.5) {
                            interp = 'Agree';
                            interpClass = 'text-success';
                        } else if (q.weighted_mean > 2.5) {
                            interp = 'Moderate';
                            interpClass = 'text-warning';
                        }
                        row.innerHTML += `<td class="${interpClass}">${interp}</td>`;
                        
                        // Total responses
                        row.innerHTML += `<td>${q.total}</td>`;
                        
                        tbody.appendChild(row);
                    });
                });

                // Update weighted means display
                if (data.averages) {
                    document.getElementById('experience-weighted-mean').textContent = data.averages.experience.toFixed(2);
                    document.getElementById('difficulty-weighted-mean').textContent = data.averages.difficulty.toFixed(2);
                    document.getElementById('control-weighted-mean').textContent = data.averages.control.toFixed(2);

                    // Dynamic conclusion based on data
                    let conclusion = '';
                    const exp = data.averages.experience;
                    const diff = data.averages.difficulty;
                    const ctrl = data.averages.control;
                    let successfulSections = [];
                    let needsImprovementSections = [];
                    if (exp >= 3.5) successfulSections.push('Experience'); else needsImprovementSections.push('Experience');
                    if (diff >= 3.5) successfulSections.push('Difficulty'); else needsImprovementSections.push('Difficulty');
                    if (ctrl >= 3.5) successfulSections.push('Control'); else needsImprovementSections.push('Control');

                    if (successfulSections.length === 3) {
                        conclusion = '<strong>Overall, the survey results are successful.</strong> All sections (Experience, Difficulty, Control) have a weighted mean of 3.5 or higher, indicating strong agreement among respondents.';
                    } else if (successfulSections.length > 0) {
                        conclusion = `<strong>Partially successful:</strong> The following section(s) are strong: <span class='text-success'>${successfulSections.join(', ')}</span>. ` +
                            `Section(s) needing improvement: <span class='text-danger'>${needsImprovementSections.join(', ')}</span>.`;
                    } else {
                        conclusion = '<strong>The survey results indicate areas for improvement.</strong> All sections have a weighted mean below 3.5, suggesting that respondents do not generally agree.';
                    }
                    document.getElementById('dynamic-conclusion').innerHTML = conclusion;
                }

                // Fill the detailed survey responses table
                const responsesBody = document.getElementById('survey-responses-body');
                if (responsesBody) {
                    responsesBody.innerHTML = '';
                    if (data.survey_responses && data.survey_responses.length > 0) {
                        data.survey_responses.forEach(resp => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${resp.student}</td>
                                <td>${resp.experience_rating}</td>
                                <td>${resp.difficulty_rating}</td>
                                <td>${resp.peu_control}</td>
                                <td>${resp.feedback || '-'}</td>
                                <td>${resp.created_at}</td>
                            `;
                            responsesBody.appendChild(row);
                        });
                    } else {
                        responsesBody.innerHTML = '<tr><td colspan="6" class="text-center">No responses found.</td></tr>';
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching survey data:', error);
                // Show error message in each table
                ['experience', 'difficulty', 'control'].forEach(section => {
                    const table = document.getElementById(`${section}-table`);
                    if (table) {
                        const tbody = table.querySelector('tbody');
                        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Error loading data: ${error.message}</td></tr>`;
                    }
                });
            });
    }

    // Initial load
    fetchSurveyData();

    // Refresh button handler
    const refreshSurveyBtn = document.getElementById('refresh-survey');
    if (refreshSurveyBtn) {
        refreshSurveyBtn.addEventListener('click', fetchSurveyData);
    }

    // Export to CSV handler
    const exportSurveyBtn = document.getElementById('export-survey');
    if (exportSurveyBtn) {
        exportSurveyBtn.addEventListener('click', function() {
            const sections = ['experience', 'difficulty', 'control'];
            let csvContent = 'data:text/csv;charset=utf-8,';
            sections.forEach(section => {
                const table = document.getElementById(`${section}-table`);
                if (!table) return;
                csvContent += `\n${section.toUpperCase()} SECTION\n`;
                const headers = Array.from(table.querySelectorAll('thead th'))
                    .map(th => th.textContent.trim());
                csvContent += headers.join(',') + '\n';
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = Array.from(row.cells)
                        .map(cell => `"${cell.textContent.trim()}"`);
                    csvContent += cells.join(',') + '\n';
                });
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'survey_analysis.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    }

function initializePerformanceChart() {
    const ctx = document.getElementById('performanceDistributionChart').getContext('2d');
    if (performanceChart) {
        performanceChart.destroy();
    }
    performanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['90-100%', '80-89%', '70-79%', '60-69%', 'Below 60%'],
            datasets: [{
                label: 'Number of Students',
                data: [0, 0, 0, 0, 0],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(255, 159, 64, 0.5)',
                    'rgba(255, 99, 132, 0.5)'
                ],
                borderColor: [
                    'rgb(75, 192, 192)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 206, 86)',
                    'rgb(255, 159, 64)',
                    'rgb(255, 99, 132)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Students'
                    }
                }
            }
        }
    });
}

function initializeSubjectSuccessChart() {
    const ctx = document.getElementById('subjectSuccessChart').getContext('2d');
    if (subjectSuccessChart) {
        subjectSuccessChart.destroy();
    }
    subjectSuccessChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Success Rate',
                data: [],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.8)',   // Green
                    'rgba(54, 162, 235, 0.8)',   // Blue
                    'rgba(255, 206, 86, 0.8)',   // Yellow
                    'rgba(255, 159, 64, 0.8)',   // Orange
                    'rgba(255, 99, 132, 0.8)',   // Red
                    'rgba(153, 102, 255, 0.8)',  // Purple
                    'rgba(201, 203, 207, 0.8)',  // Gray
                    'rgba(255, 99, 71, 0.8)',    // Tomato
                    'rgba(46, 139, 87, 0.8)',    // Sea Green
                    'rgba(218, 112, 214, 0.8)'   // Orchid
                ],
                borderColor: [
                    'rgb(75, 192, 192)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 206, 86)',
                    'rgb(255, 159, 64)',
                    'rgb(255, 99, 132)',
                    'rgb(153, 102, 255)',
                    'rgb(201, 203, 207)',
                    'rgb(255, 99, 71)',
                    'rgb(46, 139, 87)',
                    'rgb(218, 112, 214)'
                ],
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw}%`;
                        }
                    },
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 10,
                    cornerRadius: 4,
                    displayColors: true
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Success Rate (%)',
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    // ... rest of the function ...
}

function initializeDifficultyChart() {
    const ctx = document.getElementById('difficultyAnalysisChart').getContext('2d');
    if (difficultyChart) {
        difficultyChart.destroy();
    }
    difficultyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Very Easy', 'Easy', 'Moderate', 'Hard', 'Very Hard'],
            datasets: [{
                label: 'Number of Questions',
                data: [0, 0, 0, 0, 0],
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Questions'
                    }
                }
            }
        }
    });
}

function initializeLearningProgressChart() {
    const ctx = document.getElementById('learningProgressChart').getContext('2d');
    if (progressChart) {
        progressChart.destroy();
    }
    progressChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5'],
            datasets: [{
                label: 'Average Score',
                data: [0, 0, 0, 0, 0],
                backgroundColor: 'rgba(255, 159, 64, 0.5)',
                borderColor: 'rgb(255, 159, 64)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Average Score (%)'
                    }
                }
            }
        }
    });
}

function updateChartTimeRange(startDate, endDate) {
    const url = `{% url 'get_performance_analytics_data' %}?start_date=${startDate}&end_date=${endDate}`;
    fetch(url)
        .then(function(response) {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(function(data) {
            updateCharts(data);
            hideLoadingSkeleton();
        })
        .catch(function(error) {
            console.error('Error fetching performance data:', error);
            // Show error message to user
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert alert-danger mt-3';
            errorMessage.textContent = 'Failed to load performance data. Please try again.';
            document.querySelector('.card-body').prepend(errorMessage);
            hideLoadingSkeleton();
        });
}

function updateCharts(data) {
    // Update Performance Distribution Chart
    performanceChart.data.datasets[0].data = data.performance_distribution;
    performanceChart.update();

    // Update Subject Success Chart with improved legend
    const subjects = Object.keys(data.subject_performance);
    const successRates = Object.values(data.subject_performance).map(d => d.success_rate);
    const progressRates = Object.values(data.subject_performance).map(d => d.progress || 0);
    
    // Update chart data
    subjectSuccessChart.data.labels = subjects;
    subjectSuccessChart.data.datasets[0].data = successRates;
    
    // Update legend
    const legendContainer = document.getElementById('subjectSuccessLegend');
    legendContainer.innerHTML = subjects.map((subject, index) => `
        <div class="legend-item">
            <div class="legend-color" style="background-color: ${subjectSuccessChart.data.datasets[0].backgroundColor[index]}"></div>
            <span>${subject}</span>
        </div>
    `).join('');

    // Update table
    const tableBody = document.getElementById('subjectSuccessTableBody');
    tableBody.innerHTML = subjects.map((subject, index) => `
        <tr>
            <td>${subject}</td>
            <td>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar ${successRates[index] >= 70 ? 'bg-success' : successRates[index] >= 40 ? 'bg-warning' : 'bg-danger'}"
                         role="progressbar"
                         style="width: ${successRates[index]}%"
                         aria-valuenow="${successRates[index]}"
                         aria-valuemin="0"
                         aria-valuemax="100">
                        ${successRates[index]}%
                    </div>
                </div>
            </td>
            <td>
                ${progressRates[index] > 0 ? 
                    `<span class="text-success">↑ ${progressRates[index]}%</span>` :
                    progressRates[index] < 0 ?
                    `<span class="text-danger">↓ ${Math.abs(progressRates[index])}%</span>` :
                    `<span class="text-muted">-</span>`
                }
            </td>
        </tr>
    `).join('');

    subjectSuccessChart.update();

    // Update Difficulty Analysis Chart
    difficultyChart.data.datasets[0].data = data.difficulty_distribution;
    difficultyChart.update();

    // Update Learning Progress Chart
    progressChart.data.datasets[0].data = data.learning_progress;
    progressChart.update();
}

// Initialize survey analysis
fetchSurveyData();

// Set up auto-refresh every 5 minutes
setInterval(fetchSurveyData, 300000);

const form = document.getElementById('date-range-form');
const startInput = document.getElementById('start-date');
const endInput = document.getElementById('end-date');
if (form && startInput && endInput) {
    form.addEventListener('submit', function() {
        if (startInput.value && endInput.value) {
            updateChartTimeRange(startInput.value, endInput.value);
        }
    });
}
// Optionally, set default dates to this week
const today = new Date();
const prior = new Date();
prior.setDate(today.getDate() - 6);
startInput.value = prior.toISOString().slice(0, 10);
endInput.value = today.toISOString().slice(0, 10);
updateChartTimeRange(startInput.value, endInput.value);
</script>

<!-- MathJax for LaTeX rendering -->
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
{% endblock content %} 